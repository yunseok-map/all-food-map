<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티 맛집/술집 지도</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Common styles */
        body {
            font-family: 'Inter', sans-serif;
            transition: background 0.5s ease, color 0.3s ease;
        }
        .hidden {
            display: none;
        }
        .accordion-content {
            transition: max-height 0.6s ease-in-out, padding 0.6s ease-in-out, border 0.6s ease-in-out;
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            border-top-width: 0;
        }
        .accordion-content.open {
            max-height: 4000px; /* Sufficiently large to accommodate content */
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-top-width: 1px;
        }
        .details {
            transition: max-height 0.5s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        .details.open {
            max-height: 1200px; /* Increased max-height for image slider */
        }

        /* Sub Tab button styles */
        .sub-tab-btn {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            margin: 0 5px;
            font-size: 0.9rem; /* Default for small screens */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .sub-tab-btn {
                font-size: 1rem;
            }
        }
        
        /* Card entry animation */
        .card-enter {
            animation: card-enter-animation 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes card-enter-animation {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .comment-post-btn {
            transition: background-color 0.2s;
        }
        .comment-delete-btn, .review-delete-btn {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .comment-item:hover .comment-delete-btn,
        .review-item:hover .review-delete-btn {
            opacity: 1;
        }

        /* Comment & Review Item Separator */
        .comment-item {
            border-width: 1px;
            padding: 0.75rem;
            border-radius: 0.75rem;
        }
        .review-item:not(:last-child) {
            border-bottom-width: 1px;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .nickname-tag {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 0.5rem;
            font-weight: 600;
            line-height: 1.2;
        }


        /* Reply specific styles */
        .reply-form-container { display: none; }
        .reply-form-container.open { display: block; }
        .reply-item {
            margin-left: 1.5rem;
            border-left-width: 2px;
            padding-left: 0.75rem;
        }
        .replies-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .replies-container.open { max-height: 2000px; }

        /* Top Control Buttons (Menu, Aurora) */
        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        .control-btn:hover {
            transform: scale(1.1);
        }

        /* Hamburger Menu Styles */
        .menu-panel {
            position: absolute;
            top: 55px;
            left: 0;
            width: 200px;
            border-radius: 12px; /* Softer radius */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 40;
            transform-origin: top left;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95) translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }
        .menu-panel.open {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
        }
        .menu-item {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            border-radius: 8px; /* Softer radius */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            margin: 0;
        }

        /* Notification Bell and Panel Styles */
        .notification-bell-container {
            position: relative;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .notification-bell-icon {
            font-size: 1.5rem;
        }
        .notification-count {
            position: absolute;
            top: 0px;
            right: 0px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .notification-panel {
            position: absolute;
            top: 55px;
            right: 0;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px; /* Softer radius */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 40;
            display: none;
            transform-origin: top right;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        .notification-panel.open { display: block; }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .notification-item {
            padding: 12px 16px;
            border-bottom-width: 1px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { font-weight: bold; }
        .notification-item-text { font-size: 0.9rem; line-height: 1.4; }
        .notification-item-time { font-size: 0.75rem; margin-top: 4px; }

        /* Special Day Banner Styles */
        #special-day-banner {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 45;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Main Content Container Adjustment */
        .main-content-container {
            margin-top: 80px;
        }
        
        /* --- Image Slider Styles --- */
        .slider-container {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .slider-track {
            display: flex;
            transition: transform 0.4s ease-in-out;
        }
        .slider-slide {
            min-width: 100%;
            box-sizing: border-box;
        }
        .slider-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: background-color 0.2s;
        }
        .slider-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .slider-btn.prev {
            left: 10px;
        }
        .slider-btn.next {
            right: 10px;
        }

        /* --- Image Lightbox Styles --- */
        #image-lightbox {
            transition: opacity 0.3s ease;
        }
        #image-lightbox img {
            transition: transform 0.3s ease;
        }
        #lightbox-prev, #lightbox-next {
            transition: background-color 0.2s;
        }
        #lightbox-prev:hover, #lightbox-next:hover {
            background-color: rgba(0,0,0,0.3);
        }


        /* --- Aurora Animation --- */
        @keyframes aurora-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Theme 1: Sikdae (Green) --- */
        body.theme-sikdae { background: radial-gradient(circle, #052e16, #061a10); color: #d1fae5; }
        .theme-sikdae .menu-item.active, .theme-sikdae .sub-tab-btn.active { background-color: #34d399; color: #064e3b; }
        .theme-sikdae .menu-item, .theme-sikdae .sub-tab-btn { background-color: rgba(16, 185, 129, 0.1); color: #a7f3d0; }
        .theme-sikdae .menu-item:hover, .theme-sikdae .sub-tab-btn:hover { background-color: rgba(16, 185, 129, 0.2); }
        .theme-sikdae .theme-bg-header, .theme-sikdae .theme-bg-card { background-color: rgba(12, 45, 33, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(52, 211, 153, 0.2); border-radius: 1rem; }
        .theme-sikdae .theme-border, .theme-sikdae .review-item { border-color: rgba(52, 211, 153, 0.2); }
        .theme-sikdae .comment-item { border-color: rgba(52, 211, 153, 0.2); background-color: rgba(16, 185, 129, 0.05); }
        .theme-sikdae .theme-text-header, .theme-sikdae .theme-text-strong { color: #6ee7b7; }
        .theme-sikdae .theme-text-title { color: #f0fdf4; }
        .theme-sikdae .theme-text-subtitle { color: #a7f3d0; }
        .theme-sikdae .theme-text-body { color: #d1fae5; }
        .theme-sikdae .ai-button { background-color: #10b981; color: white; }
        .theme-sikdae .ai-button:hover:not(:disabled) { background-color: #059669; }
        .theme-sikdae .ai-button:disabled { background-color: #34d399; opacity: 0.6; cursor: not-allowed; }
        .theme-sikdae .ai-result { background-color: rgba(16, 185, 129, 0.1); border-left: 3px solid #34d399; }
        .theme-sikdae .map-link { color: #6ee7b7; }
        .theme-sikdae .input-field, .theme-sikdae .comment-input, .theme-sikdae .filter-select { background-color: rgba(12, 45, 33, 0.8); color: #d1fae5; border-color: rgba(52, 211, 153, 0.3); }
        .theme-sikdae .input-field::placeholder, .theme-sikdae .comment-input::placeholder { color: #6ee7b7; opacity: 0.7; }
        .theme-sikdae .comment-post-btn { background-color: #10b981; color: white; }
        .theme-sikdae .comment-post-btn:hover { background-color: #059669; }
        .theme-sikdae #presence-counter, .theme-sikdae .control-btn { background-color: #10b981; color: white; }
        .theme-sikdae .notification-panel { background-color: #0c2d21; color: #d1fae5; border: 1px solid rgba(52, 211, 153, 0.2); }
        .theme-sikdae .notification-item { border-color: rgba(52, 211, 153, 0.2); }
        .theme-sikdae .notification-item.unread { background-color: rgba(16, 185, 129, 0.1); }
        .theme-sikdae .notification-item:hover { background-color: rgba(16, 185, 129, 0.2); }
        .theme-sikdae .notification-item-time { color: #a7f3d0; }
        .theme-sikdae #special-day-banner { background-color: rgba(16, 185, 129, 0.8); color: white; }
        .theme-sikdae .reply-item { border-color: rgba(52, 211, 153, 0.3); }
        .theme-sikdae .nickname-tag { background-color: rgba(52, 211, 153, 0.2); color: #a7f3d0; }

        body.theme-sikdae.aurora-mode {
            background: linear-gradient(270deg, #052e16, #064e3b, #10b981, #0c2d21);
            background-size: 400% 400%;
            animation: aurora-animation 25s ease infinite;
        }

        /* --- Theme 2: Gangnam (Purple) --- */
        body.theme-gangnam { background: radial-gradient(circle, #3b0764, #1e0532); color: #f3e8ff; }
        .theme-gangnam .menu-item.active, .theme-gangnam .sub-tab-btn.active { background-color: #c084fc; color: #3b0764; }
        .theme-gangnam .menu-item, .theme-gangnam .sub-tab-btn { background-color: rgba(168, 85, 247, 0.1); color: #e9d5ff; }
        .theme-gangnam .menu-item:hover, .theme-gangnam .sub-tab-btn:hover { background-color: rgba(168, 85, 247, 0.2); }
        .theme-gangnam .theme-bg-header, .theme-gangnam .theme-bg-card { background-color: rgba(40, 16, 64, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(192, 132, 252, 0.2); border-radius: 1rem; }
        .theme-gangnam .theme-border, .theme-gangnam .review-item { border-color: rgba(192, 132, 252, 0.2); }
        .theme-gangnam .comment-item { border-color: rgba(192, 132, 252, 0.2); background-color: rgba(168, 85, 247, 0.05); }
        .theme-gangnam .theme-text-header, .theme-gangnam .theme-text-strong { color: #d8b4fe; }
        .theme-gangnam .theme-text-title { color: #f3e8ff; }
        .theme-gangnam .theme-text-subtitle { color: #e9d5ff; }
        .theme-gangnam .theme-text-body { color: #f3e8ff; }
        .theme-gangnam .ai-button { background-color: #a855f7; color: white; }
        .theme-gangnam .ai-button:hover:not(:disabled) { background-color: #9333ea; }
        .theme-gangnam .ai-button:disabled { background-color: #c084fc; opacity: 0.6; cursor: not-allowed; }
        .theme-gangnam .ai-result { background-color: rgba(168, 85, 247, 0.1); border-left: 3px solid #a855f7; }
        .theme-gangnam .map-link { color: #d8b4fe; }
        .theme-gangnam .input-field, .theme-gangnam .comment-input, .theme-gangnam .filter-select { background-color: rgba(40, 16, 64, 0.8); color: #f3e8ff; border-color: rgba(192, 132, 252, 0.3); }
        .theme-gangnam .input-field::placeholder, .theme-gangnam .comment-input::placeholder { color: #d8b4fe; opacity: 0.7; }
        .theme-gangnam .comment-post-btn { background-color: #a855f7; color: white; }
        .theme-gangnam .comment-post-btn:hover { background-color: #9333ea; }
        .theme-gangnam #presence-counter, .theme-gangnam .control-btn { background-color: #a855f7; color: white; }
        .theme-gangnam .notification-panel { background-color: #281040; color: #f3e8ff; border: 1px solid rgba(192, 132, 252, 0.2); }
        .theme-gangnam .notification-item { border-color: rgba(192, 132, 252, 0.2); }
        .theme-gangnam .notification-item.unread { background-color: rgba(168, 85, 247, 0.1); }
        .theme-gangnam .notification-item:hover { background-color: rgba(168, 85, 247, 0.2); }
        .theme-gangnam .notification-item-time { color: #e9d5ff; }
        .theme-gangnam #special-day-banner { background-color: rgba(168, 85, 247, 0.8); color: white; }
        .theme-gangnam .reply-item { border-color: rgba(192, 132, 252, 0.3); }
        .theme-gangnam .nickname-tag { background-color: rgba(192, 132, 252, 0.2); color: #e9d5ff; }
        
        body.theme-gangnam.aurora-mode {
            background: linear-gradient(270deg, #3b0764, #581c87, #9333ea, #281040);
            background-size: 400% 400%;
            animation: aurora-animation 25s ease infinite;
        }

        /* --- Theme 3: Community (Blue) --- */
        body.theme-community { background: radial-gradient(circle, #0c2a4d, #051425); color: #dbeafe; }
        .theme-community .menu-item.active, .theme-community .sub-tab-btn.active { background-color: #3b82f6; color: white; }
        .theme-community .menu-item, .theme-community .sub-tab-btn { background-color: rgba(59, 130, 246, 0.1); color: #93c5fd; }
        .theme-community .menu-item:hover, .theme-community .sub-tab-btn:hover { background-color: rgba(59, 130, 246, 0.2); }
        .theme-community .theme-bg-header, .theme-community .theme-bg-card { background-color: rgba(14, 37, 63, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 1rem; }
        .theme-community .theme-border, .theme-community .review-item { border-color: rgba(96, 165, 250, 0.2); }
        .theme-community .comment-item { border-color: rgba(96, 165, 250, 0.2); background-color: rgba(59, 130, 246, 0.05); }
        .theme-community .theme-text-header, .theme-community .theme-text-strong { color: #93c5fd; }
        .theme-community .theme-text-title { color: #dbeafe; }
        .theme-community .theme-text-subtitle { color: #bfdbfe; }
        .theme-community .theme-text-body { color: #dbeafe; }
        .theme-community .map-link { color: #93c5fd; }
        .theme-community .community-button { background: #2563eb; color: white; border-radius: 9999px; }
        .theme-community .community-button:hover { background: #1d4ed8; }
        .theme-community .community-button:disabled { background: #60a5fa; opacity: 0.6; cursor: not-allowed; }
        .theme-community .comment-input, .theme-community .input-field, .theme-community .filter-select { background-color: rgba(14, 37, 63, 0.8); color: #dbeafe; border-color: rgba(96, 165, 250, 0.3); }
        .theme-community .comment-input::placeholder, .theme-community .input-field::placeholder { color: #93c5fd; opacity: 0.7; }
        .theme-community .comment-post-btn { background-color: #2563eb; color: white; }
        .theme-community .comment-post-btn:hover { background-color: #1d4ed8; }
        .theme-community #presence-counter, .theme-community .control-btn { background-color: #2563eb; color: white; }
        .theme-community .notification-panel { background-color: #0e253f; color: #dbeafe; border: 1px solid rgba(96, 165, 250, 0.2); }
        .theme-community .notification-item { border-color: rgba(96, 165, 250, 0.2); }
        .theme-community .notification-item.unread { background-color: rgba(59, 130, 246, 0.1); }
        .theme-community .notification-item:hover { background-color: rgba(59, 130, 246, 0.2); }
        .theme-community .notification-item-time { color: #bfdbfe; }
        .theme-community #special-day-banner { background-color: rgba(37, 99, 235, 0.8); color: white; }
        .theme-community .reply-item { border-color: rgba(96, 165, 250, 0.3); }
        .theme-community .nickname-tag { background-color: rgba(96, 165, 250, 0.2); color: #bfdbfe; }

        body.theme-community.aurora-mode {
            background: linear-gradient(270deg, #0c2a4d, #1e40af, #3b82f6, #0e253f);
            background-size: 400% 400%;
            animation: aurora-animation 25s ease infinite;
        }

        /* --- Theme 4: Pub (Amber/Orange) --- */
        body.theme-pub { background: radial-gradient(circle, #451a03, #200d02); color: #ffedd5; }
        .theme-pub .menu-item.active, .theme-pub .sub-tab-btn.active { background-color: #f97316; color: #451a03; }
        .theme-pub .menu-item, .theme-pub .sub-tab-btn { background-color: rgba(249, 115, 22, 0.1); color: #fdba74; }
        .theme-pub .menu-item:hover, .theme-pub .sub-tab-btn:hover { background-color: rgba(249, 115, 22, 0.2); }
        .theme-pub .theme-bg-header, .theme-pub .theme-bg-card { background-color: rgba(30, 16, 5, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(251, 146, 60, 0.2); border-radius: 1rem; }
        .theme-pub .theme-border, .theme-pub .review-item { border-color: rgba(251, 146, 60, 0.2); }
        .theme-pub .comment-item { border-color: rgba(251, 146, 60, 0.2); background-color: rgba(249, 115, 22, 0.05); }
        .theme-pub .theme-text-header, .theme-pub .theme-text-strong { color: #fb923c; }
        .theme-pub .theme-text-title { color: #ffedd5; }
        .theme-pub .theme-text-subtitle { color: #fdba74; }
        .theme-pub .theme-text-body { color: #ffedd5; }
        .theme-pub .ai-button { background-color: #f97316; color: white; }
        .theme-pub .ai-button:hover:not(:disabled) { background-color: #ea580c; }
        .theme-pub .ai-button:disabled { background-color: #fb923c; opacity: 0.6; cursor: not-allowed; }
        .theme-pub .ai-result { background-color: rgba(249, 115, 22, 0.1); border-left: 3px solid #f97316; }
        .theme-pub .map-link { color: #fb923c; }
        .theme-pub .input-field, .theme-pub .comment-input, .theme-pub .filter-select { background-color: rgba(30, 16, 5, 0.8); color: #ffedd5; border-color: rgba(251, 146, 60, 0.3); }
        .theme-pub .input-field::placeholder, .theme-pub .comment-input::placeholder { color: #fdba74; opacity: 0.7; }
        .theme-pub .comment-post-btn { background-color: #f97316; color: white; }
        .theme-pub .comment-post-btn:hover { background-color: #ea580c; }
        .theme-pub #presence-counter, .theme-pub .control-btn { background-color: #f97316; color: white; }
        .theme-pub .notification-panel { background-color: #200d02; color: #ffedd5; border: 1px solid rgba(251, 146, 60, 0.2); }
        .theme-pub .notification-item { border-color: rgba(251, 146, 60, 0.2); }
        .theme-pub .notification-item.unread { background-color: rgba(249, 115, 22, 0.1); }
        .theme-pub .notification-item:hover { background-color: rgba(249, 115, 22, 0.2); }
        .theme-pub .notification-item-time { color: #fdba74; }
        .theme-pub #special-day-banner { background-color: rgba(249, 115, 22, 0.8); color: white; }
        .theme-pub .reply-item { border-color: rgba(251, 146, 60, 0.3); }
        .theme-pub .nickname-tag { background-color: rgba(251, 146, 60, 0.2); color: #fdba74; }

        body.theme-pub.aurora-mode {
            background: linear-gradient(270deg, #451a03, #78350f, #f97316, #200d02);
            background-size: 400% 400%;
            animation: aurora-animation 25s ease infinite;
        }

    </style>
</head>
<body>
    <!-- Hamburger Menu -->
    <div id="menu-container" class="fixed top-4 left-2 sm:left-4 z-[60]">
        <button id="menu-toggle-btn" class="control-btn">
            <i class="fas fa-bars"></i>
        </button>
        <div id="menu-panel" class="menu-panel">
            <button data-tab="community" class="menu-item tab-btn active">커뮤니티</button>
            <button data-tab="integrated-map" class="menu-item tab-btn">통합지도</button>
        </div>
    </div>

    <!-- Special Day Banner -->
    <div id="special-day-banner" class="hidden">
        <i class="fas fa-calendar-alt"></i>
        <span id="special-day-text"></span>
    </div>

    <!-- Top Right Controls -->
    <div class="fixed top-4 right-2 sm:right-4 z-50 flex items-center space-x-2">
        <div id="presence-counter" class="text-sm font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300"></div>
        <button id="aurora-toggle-btn" class="control-btn">✨</button>
        <div class="notification-bell-container">
            <i id="notification-bell-icon" class="fas fa-bell notification-bell-icon"></i>
            <span id="notification-count" class="notification-count hidden">0</span>
            <div id="notification-panel" class="notification-panel">
                <div class="p-3 text-center theme-text-header font-semibold border-b theme-border flex justify-between items-center">
                    <span>새로운 댓글 알림</span>
                    <button id="clear-all-notifications-btn" class="text-xs text-red-400 hover:text-red-200 font-semibold px-2 py-1 rounded-md border border-red-400 hover:border-red-200 transition-colors">모두 삭제</button>
                </div>
                <div id="notification-list-content" class="py-2">
                    <p class="text-center text-sm theme-text-subtitle py-4">새로운 알림이 없습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 main-content-container">
        <!-- Main content will be dynamically shown here -->
        
        <!-- ==================== Community Page Content ==================== -->
        <div id="community-content" class="page-content">
            <header class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold theme-text-title">맛집 커뮤니티</h1>
                <p class="theme-text-subtitle mt-2 text-sm md:text-base">랜덤 맛집을 뽑아보거나, 자유롭게 이야기를 나눠보세요.</p>
            </header>
            <main class="space-y-8 md:space-y-12">
                <section class="text-center p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">오늘의 메뉴 뽑기 🎉</h2>
                    <button id="community-draw-btn" class="community-button font-bold text-base md:text-lg px-4 py-2 md:px-6 md:py-3">오늘 뭐 먹지? 😋 (메뉴 뽑기)</button>
                    <div id="community-result-container" class="mt-6 md:mt-8 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 min-h-[100px]">
                        <!-- Drawing results will be displayed here. -->
                    </div>
                </section>

                <!-- 자유 게시판 -->
                <section class="p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <div id="toggle-general-comments" class="flex justify-between items-center cursor-pointer">
                        <h2 class="text-xl md:text-2xl font-bold theme-text-header">자유 게시판 💬</h2>
                        <svg class="w-5 h-5 md:w-6 md:h-6 theme-text-header transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="general-comments-container" class="accordion-content mt-4 theme-border">
                        <div id="general-comment-list" class="space-y-4 mb-4"></div>
                        <div class="comment-form space-y-2 mt-4">
                            <input type="text" id="general-nickname-input" class="comment-input w-full p-2 rounded-md border text-sm" placeholder="닉네임을 입력하세요...">
                            <textarea id="general-comment-input" class="comment-input w-full p-2 rounded-md border text-sm" placeholder="자유로운 이야기를 남겨주세요..." rows="3"></textarea>
                            <button type="button" id="general-comment-post-btn" class="comment-post-btn w-full px-4 py-2 rounded-md font-semibold text-sm">등록</button>
                        </div>
                    </div>
                </section>

                <!-- 맛집 추천 게시판 -->
                <section class="p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <div id="toggle-restaurant-comments" class="flex justify-between items-center cursor-pointer">
                        <h2 class="text-xl md:text-2xl font-bold theme-text-header">맛집 추천 게시판 🍽️</h2>
                        <svg class="w-5 h-5 md:w-6 md:h-6 theme-text-header transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="restaurant-comments-container" class="accordion-content mt-4 theme-border">
                        <div id="restaurant-comment-list" class="space-y-4 mb-4"></div>
                        <div class="comment-form space-y-2 mt-4">
                            <input type="text" id="restaurant-nickname-input" class="comment-input w-full p-2 rounded-md border text-sm" placeholder="닉네임을 입력하세요...">
                            <textarea id="restaurant-comment-input" class="comment-input w-full p-2 rounded-md border text-sm" placeholder="추천 맛집에 대한 이야기를 남겨주세요..." rows="3"></textarea>
                            <button type="button" id="restaurant-comment-post-btn" class="comment-post-btn w-full px-4 py-2 rounded-md font-semibold text-sm">등록</button>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-8 md:mt-12 text-purple-200 text-xs md:text-sm"><p>모두가 함께 만드는 맛집 지도!</p></footer>
        </div>

        <!-- ==================== Integrated Map Page Content ==================== -->
        <div id="integrated-map-content" class="page-content hidden">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold theme-text-title">통합 지도</h1>
                <p class="theme-text-subtitle mt-2 text-sm md:text-base">다양한 카테고리의 맛집과 술집을 한눈에!</p>
            </header>
            
            <!-- Sub-Tab Navigation for Integrated Map -->
            <nav class="flex flex-wrap justify-center mb-8">
                <button id="sub-tab-sikdae" data-sub-tab="sikdae" class="sub-tab-btn active">식권대장용</button>
                <button id="sub-tab-gangnam" data-sub-tab="gangnam" class="sub-tab-btn">강남/신논현</button>
                <button id="sub-tab-pub" data-sub-tab="pub" class="sub-tab-btn">일하느라 지쳤으니 한 잔</button>
            </nav>

            <!-- Sub-Content for Sikdae -->
            <div id="sikdae-sub-content" class="sub-page-content">
                <section class="mb-8 md:mb-10 p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">AI 맛집 추천 🤖</h2>
                    <p class="theme-text-subtitle mb-4 text-xs md:text-sm">식권대장으로 먹고 싶은 메뉴나 상황을 알려주세요!</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="sikdae-ai-prompt-input" class="flex-grow p-2 md:p-3 rounded-md focus:ring-2 focus:ring-green-400 focus:outline-none input-field text-sm" placeholder="예: 든든한 한식, 간단한 샌드위치">
                        <button id="sikdae-ai-recommend-btn" class="ai-button px-4 py-2 md:px-6 md:py-3 rounded-md font-semibold text-sm">추천받기</button>
                    </div>
                    <div id="sikdae-ai-result-container" class="mt-4 p-3 md:p-4 rounded-md text-xs md:text-sm theme-text-body ai-result min-h-[50px]"><p>AI의 추천을 기다리고 있어요...</p></div>
                </section>
                <section class="mb-8 md:mb-10 p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">음식점 검색 및 필터링 🔎</h2>
                    <p class="theme-text-subtitle mb-4 text-xs md:text-sm">가게 이름, 메뉴, 코멘트, 카테고리로 검색하고 가격대로 필터링해보세요.</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                        <input type="text" id="sikdae-search-input" class="flex-grow p-2 md:p-3 rounded-md focus:ring-2 focus:ring-green-400 focus:outline-none input-field text-sm" placeholder="예: 돈까스, 순대국밥, 강남역">
                        <select id="sikdae-price-filter" class="p-2 md:p-3 rounded-md border theme-border input-field text-sm filter-select">
                            <option value="all">가격대 전체</option>
                            <option value="under-10000">만원 미만</option>
                            <option value="10000-20000">만원 ~ 2만원</option>
                            <option value="20000-30000">2만원 ~ 3만원</option>
                            <option value="over-30000">3만원 이상</option>
                        </select>
                        <select id="sikdae-sort-order" class="p-2 md:p-3 rounded-md border theme-border input-sm filter-select">
                            <option value="category">카테고리별 정렬</option>
                            <option value="name-asc">이름 가나다순</option>
                        </select>
                    </div>
                </section>
                <div id="sikdae-restaurant-sections" class="space-y-3 md:space-y-4"></div>
                <footer class="text-center mt-8 md:mt-12 text-gray-600 text-xs md:text-sm"><p>식권대장 지도 기반으로 하나하나 취합되어서 누락된 부분이 있을 수도 있습니다.</p></footer>
            </div>

            <!-- Sub-Content for Gangnam/Sinnonhyeon -->
            <div id="gangnam-sub-content" class="sub-page-content hidden">
                <section class="mb-8 md:mb-10 p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">AI 맛집 추천 🤖</h2>
                    <p class="theme-text-subtitle mb-4 text-xs md:text-sm">오늘 뭐 먹을지 고민될 때, AI에게 물어보세요! (예: 매콤한 국물, 혼밥하기 좋은 곳)</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="gangnam-ai-prompt-input" class="flex-grow p-2 md:p-3 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none input-field text-sm" placeholder="어떤 음식을 원하세요?">
                        <button id="gangnam-ai-recommend-btn" class="ai-button px-4 py-2 md:px-6 md:py-3 rounded-md font-semibold text-sm">추천받기</button>
                    </div>
                    <div id="gangnam-ai-result-container" class="mt-4 p-3 md:p-4 rounded-md text-xs md:text-sm theme-text-body ai-result min-h-[50px]"><p>AI의 추천을 기다리고 있어요...</p></div>
                </section>
                <section class="mb-8 md:mb-10 p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">음식점 검색 및 필터링 🔎</h2>
                    <p class="theme-text-subtitle mb-4 text-xs md:text-sm">가게 이름, 메뉴, 코멘트, 카테고리로 검색하고 가격대로 필터링해보세요.</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                        <input type="text" id="gangnam-search-input" class="flex-grow p-2 md:p-3 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none input-field text-sm" placeholder="예: 돈까스, 순대국밥, 강남역">
                        <select id="gangnam-price-filter" class="p-2 md:p-3 rounded-md border theme-border input-field text-sm filter-select">
                            <option value="all">가격대 전체</option>
                            <option value="under-10000">만원 미만</option>
                            <option value="10000-20000">만원 ~ 2만원</option>
                            <option value="20000-30000">2만원 ~ 3만원</option>
                            <option value="over-30000">3만원 이상</option>
                        </select>
                        <select id="gangnam-sort-order" class="p-2 md:p-3 rounded-md border theme-border input-field text-sm filter-select">
                            <option value="category">카테고리별 정렬</option>
                            <option value="name-asc">이름 가나다순</option>
                        </select>
                    </div>
                </section>
                <div id="gangnam-restaurant-sections" class="space-y-3 md:space-y-4"></div>
                <footer class="text-center mt-8 md:mt-12 text-gray-400 text-xs md:text-sm"><p>맛집 데이터 기반으로 제작되었습니다.</p></footer>
            </div>

            <!-- Sub-Content for Pub Map -->
            <div id="pub-sub-content" class="sub-page-content hidden">
                <section class="mb-8 md:mb-10 p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">AI 술집 추천 🍻</h2>
                    <p class="theme-text-subtitle mb-4 text-xs md:text-sm">어떤 분위기에서 한 잔 하고 싶으신가요? AI에게 물어보세요!</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="pub-ai-prompt-input" class="flex-grow p-2 md:p-3 rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none input-field text-sm" placeholder="예: 시끌벅적한 맥주집, 조용한 와인바">
                        <button id="pub-ai-recommend-btn" class="ai-button px-4 py-2 md:px-6 md:py-3 rounded-md font-semibold text-sm">추천받기</button>
                    </div>
                    <div id="pub-ai-result-container" class="mt-4 p-3 md:p-4 rounded-md text-xs md:text-sm theme-text-body ai-result min-h-[50px]"><p>AI의 추천을 기다리고 있어요...</p></div>
                </section>
                <section class="mb-8 md:mb-10 p-4 sm:p-6 rounded-2xl theme-bg-header shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold theme-text-header mb-4">술집 검색 및 필터링 🔍</h2>
                    <p class="theme-text-subtitle mb-4 text-xs md:text-sm">가게 이름, 메뉴, 분위기, 카테고리로 검색하고 가격대로 필터링해보세요.</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                        <input type="text" id="pub-search-input" class="flex-grow p-2 md:p-3 rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none input-field text-sm" placeholder="예: 맥주, 칵테일, 강남역">
                        <select id="pub-price-filter" class="p-2 md:p-3 rounded-md border theme-border input-field text-sm filter-select">
                            <option value="all">가격대 전체</option>
                            <option value="under-20000">2만원 미만</option>
                            <option value="20000-40000">2만원 ~ 4만원</option>
                            <option value="over-40000">4만원 이상</option>
                        </select>
                        <select id="pub-sort-order" class="p-2 md:p-3 rounded-md border theme-border input-field text-sm filter-select">
                            <option value="category">카테고리별 정렬</option>
                            <option value="name-asc">이름 가나다순</option>
                        </select>
                    </div>
                </section>
                <div id="pub-restaurant-sections" class="space-y-3 md:space-y-4"></div>
                <footer class="text-center mt-8 md:mt-12 text-gray-400 text-xs md:text-sm"><p>신나는 술집 탐방!</p></footer>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="px-5 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">예</button>
                <button id="confirm-no-btn" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">아니오</button>
            </div>
        </div>
    </div>
    
    <!-- Image Lightbox Modal -->
    <div id="image-lightbox" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100] hidden">
        <button id="lightbox-close" class="absolute top-5 right-5 text-white text-4xl font-bold hover:text-gray-300">&times;</button>
        <button id="lightbox-prev" class="absolute left-5 text-white text-4xl p-2 rounded-full hover:bg-black hover:bg-opacity-20">&#10094;</button>
        <img id="lightbox-image" src="" class="max-w-[90vw] max-h-[90vh] object-contain">
        <button id="lightbox-next" class="absolute right-5 text-white text-4xl p-2 rounded-full hover:bg-black hover:bg-opacity-20">&#10095;</button>
    </div>


    <script type="module">
        // Supabase module import
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // ==================== Supabase Settings ====================
        const SUPABASE_URL = 'https://fwguhpotzrwlklnrdvpx.supabase.co'; // User provided URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3Z3VocG90enJ3bGtsbnJkdnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMzU3MTUsImV4cCI6MjA2NzcxMTcxNX0.sprNAKUIcPphbcvk9Q3ZEvTUmezCkB1yfOr64ksauAM'; 
        
        let supabase;
        let currentUserId = null; // Variable to store the current user's ID (will be a UUID from Supabase Auth or null)

        // Declare comment-related variables globally or in a scope accessible by renderComment
        let generalNicknameInput;
        let restaurantNicknameInput;
        let generalCommentList;
        let restaurantCommentList;

        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized successfully.");
        } catch (error) {
            console.error("Supabase Initialization Error:", error);
        }

        let allRestaurantsData = []; // Global variable to store all fetched restaurant data

        // ==================== Data Definition ====================
        const sikdaeCategoryOrder = ['샐러드 🥗', '한식 🫕', '일식 🍣', '중식 🍜', '양식 🍔', '아시안음식 🍲', '분식 🥢', '카페/디저트 ☕', '프랜차이즈 🍔', '편의점 🏪'];
        const gangnamCategoryOrder = ['한식 🫕', '일식 🍣', '중식 🍜', '양식 🍔', '아시아 🍲', '샐러드 🥗'];
        const pubCategoryOrder = ['소주 🍶', '맥주 🍺', '막걸리 🍻', '칵테일 🍸', '와인 🍷', '느좋 ✨'];
        
        // ==================== Lightbox Variables ====================
        let lightbox, lightboxImage, lightboxClose, lightboxPrev, lightboxNext;
        let currentLightboxImages = [];
        let currentLightboxIndex = 0;

        // ==================== Common Functions ====================
        
        /**
         * Custom confirmation modal replacement for window.confirm()
         * @param {string} message - The message to display in the confirmation modal.
         * @returns {Promise<boolean>} A promise that resolves to true if 'Yes' is clicked, false otherwise.
         */
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const msgEl = document.getElementById('confirm-message');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                msgEl.textContent = message;
                modal.classList.remove('hidden');

                const handleYes = () => {
                    modal.classList.add('hidden');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    modal.classList.add('hidden');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                yesBtn.addEventListener('click', handleYes);
                noBtn.addEventListener('click', handleNo);
            });
        }

        /**
         * Displays a temporary message within a specific review section.
         * @param {HTMLElement} reviewSection - The parent review section element.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message (red text), false for success (green text).
         */
        function showReviewMessage(reviewSection, message, isError = true) {
            let messageDiv = reviewSection.querySelector('.review-message');
            if (!messageDiv) {
                // Create if it doesn't exist
                messageDiv = document.createElement('div');
                messageDiv.className = 'review-message mt-2 text-sm text-center';
                // Find the post-review-btn and insert the message after it
                const postReviewBtn = reviewSection.querySelector('.post-review-btn');
                if (postReviewBtn) {
                    postReviewBtn.parentNode.insertBefore(messageDiv, postReviewBtn.nextSibling);
                } else {
                    // Fallback if button not found, append to reviewSection
                    reviewSection.appendChild(messageDiv);
                }
            }
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden', 'text-red-500', 'text-green-500');
            messageDiv.classList.add(isError ? 'text-red-500' : 'text-green-500');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
                messageDiv.textContent = '';
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Parses a price string into a numerical range for filtering.
         * @param {string} priceStr - The price string from the restaurant data (e.g., "1만원 내외", "1만원 ~ 2만원").
         * @returns {{min: number, max: number}} An object with min and max price in KRW, or a default for unknown.
         */
        function parsePriceStringForRange(priceStr) {
            if (!priceStr) return { min: 0, max: Infinity }; // Default to all if price is null/empty

            priceStr = priceStr.trim();
            if (priceStr.includes('미만')) {
                const value = parseInt(priceStr.replace('만원 미만', '0000').replace('천원 미만', '000').trim());
                return { min: 0, max: value - 1 };
            } else if (priceStr.includes('이상')) {
                const value = parseInt(priceStr.replace('만원 이상', '0000').replace('천원 이상', '000').trim());
                return { min: value, max: Infinity };
            } else if (priceStr.includes('~')) {
                const parts = priceStr.split('~').map(s => parseInt(s.replace('만원', '0000').replace('천원', '000').trim()));
                // Ensure the max value is just below the next threshold to prevent overlaps
                return { min: parts[0], max: parts[1] - 1 };
            } else {
                // Attempt to parse any other numerical string directly
                const value = parseInt(priceStr.replace('만원', '0000').replace('천원', '000').trim());
                if (!isNaN(value)) {
                    return { min: value, max: value };
                }
            }
            return { min: 0, max: Infinity }; // Fallback for unparseable or unexpected formats
        }

        /**
         * Converts a price string to a single comparable numerical value for sorting.
         * This is a simplified representation.
         * @param {string} priceStr - The price string from the restaurant data.
         * @returns {number} A numerical representation of the price.
         */
        function getSortablePrice(priceStr) {
            if (!priceStr) return 0; // Treat as cheapest for sorting if unknown

            priceStr = priceStr.trim();
            if (priceStr.includes('미만')) {
                return parseInt(priceStr.replace('만원 미만', '0000').replace('천원 미만', '000').trim()) - 1;
            } else if (priceStr.includes('이상')) {
                return parseInt(priceStr.replace('만원 이상', '0000').replace('천원 이상', '000').trim());
            } else if (priceStr.includes('~')) {
                const parts = priceStr.split('~').map(s => parseInt(s.replace('만원', '0000').replace('천원', '000').trim()));
                return parts[0]; // Use the lower bound for sorting
            } else if (priceStr.includes('내외')) {
                return parseInt(priceStr.replace('만원 내외', '0000').replace('천원 내외', '000').trim());
            } else {
                const value = parseInt(priceStr.replace('만원', '0000').replace('천원', '000').trim());
                return isNaN(value) ? 0 : value;
            }
        }

        async function getAiRecommendation(prompt, data, resultContainer, button) {
            const userInput = prompt.trim();
            if (!userInput) {
                resultContainer.innerHTML = '<p>추천받고 싶은 음식이나 상황을 입력해주세요!</p>';
                return;
            }
            button.innerHTML = '🤖 생각 중...';
            button.disabled = true;
            resultContainer.innerHTML = '<p>최적의 맛집을 찾고 있어요...</p>';
            const simplifiedList = data.map(r => ({ name: r.name, category: r.category ? r.category.split(' ')[0] : '', menu: r.menu, comment: r.comment }));
            const restaurantListString = JSON.stringify(simplifiedList);
            const apiPrompt = `당신은 서울 강남의 직장인들을 위한 맛집 추천 AI입니다. 사용자의 요청에 가장 적합한 식당을 아래 리스트에서 최대 3개까지 추천해주세요. 각 식당을 추천하는 창의적이고 설득력 있는 이유를 함께 제시해야 합니다. 응답은 반드시 HTML <ul> 리스트 형식으로 작성해주세요.\n\n사용자 요청: "${userInput}"\n\n맛집 리스트:\n${restaurantListString}\n\nHTML 응답 예시:\n<ul>\n  <li><strong>식당 이름 1:</strong> 이 식당을 추천하는 재치 있는 이유.</li>\n  <li><strong>식당 이름 2:</strong> 이 식당을 추천하는 또 다른 재치 있는 이유.</li>\n</ul>`;
            const chatHistory = [{ role: "user", parts: [{ text: apiPrompt }] }];
            const payload = { contents: chatHistory };
            // Gemini API Key: User provided key
            const apiKey = "AIzaSyADS3LJHxDfisvRMmkVig-W0ppee-TX5xM"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    let text = result.candidates[0].content.parts[0].text;
                    text = text.replace(/```html/g, '').replace(/```/g, '').trim();
                    resultContainer.innerHTML = text;
                } else {
                    resultContainer.innerHTML = '<p>추천 맛집을 찾지 못했어요. 다른 키워드로 시도해보세요.</p>';
                }
            } catch (error) {
                console.error("AI Recommendation Error:", error);
                resultContainer.innerHTML = '<p>오류가 발생했어요. 잠시 후 다시 시도해주세요.</p>';
            } finally {
                button.innerHTML = '추천받기';
                button.disabled = false;
            }
        }

        /**
         * Renders the star rating input for a given container and restaurant ID.
         * @param {HTMLElement} container - The div element to render stars into.
         * @param {string} restaurantId - The ID of the restaurant.
         */
        function renderStarRatingInput(container, restaurantId) {
            container.innerHTML = ''; // Clear previous stars
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = 'text-xl cursor-pointer text-gray-400 hover:text-yellow-400 transition-colors duration-100';
                star.innerHTML = '&#9733;'; // Unicode star
                star.dataset.rating = i;
                star.addEventListener('click', () => {
                    // Set rating
                    const stars = container.querySelectorAll('span');
                    stars.forEach((s, index) => {
                        s.classList.toggle('text-yellow-400', index < i);
                        s.classList.toggle('text-gray-400', index >= i);
                    });
                    container.dataset.currentRating = i; // Store selected rating
                });
                star.addEventListener('mouseover', () => {
                    const stars = container.querySelectorAll('span');
                    const hoverRating = parseInt(star.dataset.rating);
                    stars.forEach((s, index) => {
                        s.classList.toggle('text-yellow-300', index < hoverRating);
                        s.classList.toggle('text-gray-400', index >= hoverRating);
                    });
                });
                star.addEventListener('mouseout', () => {
                    const stars = container.querySelectorAll('span');
                    const currentRating = parseInt(container.dataset.currentRating || 0);
                    stars.forEach((s, index) => {
                        s.classList.toggle('text-yellow-400', index < currentRating);
                        s.classList.toggle('text-gray-400', index >= currentRating);
                        s.classList.remove('text-yellow-300'); // Remove hover effect
                    });
                });
                container.appendChild(star);
            }
            container.dataset.currentRating = 0; // Initialize current rating to 0
        }

        /**
         * Renders the displayed star rating (read-only).
         * @param {number} rating - The rating value (1-5).
         * @returns {string} HTML string for stars.
         */
        function renderDisplayedStars(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<span class="text-yellow-400 text-sm">${i <= rating ? '&#9733;' : '&#9734;'}</span>`;
            }
            return starsHtml;
        }

        /**
         * Fetches and renders reviews for a specific restaurant.
         * @param {string} restaurantId - The ID of the restaurant.
         * @param {HTMLElement} reviewsListElement - The DOM element to render reviews into.
         * @param {HTMLElement} reviewSectionParent - The parent .review-section element to show messages.
         */
        async function fetchAndRenderReviews(restaurantId, reviewsListElement, reviewSectionParent) {
            if (!supabase) return;
            try {
                const { data: reviews, error } = await supabase
                    .from('restaurant_reviews')
                    .select('*')
                    .eq('restaurant_id', restaurantId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching reviews:', error.message);
                    showReviewMessage(reviewSectionParent, `리뷰를 불러오는 중 오류가 발생했습니다: ${error.message}`, true);
                    reviewsListElement.innerHTML = `<p class="text-sm text-red-400 text-center">리뷰를 불러오는 중 오류가 발생했습니다.</p>`;
                    return;
                }

                reviewsListElement.innerHTML = ''; // Clear existing reviews
                if (reviews.length === 0) {
                    reviewsListElement.innerHTML = '<p class="text-sm theme-text-subtitle text-center">아직 리뷰가 없습니다. 첫 리뷰를 남겨보세요!</p>';
                } else {
                    reviews.forEach(review => {
                        const reviewItem = document.createElement('div');
                        reviewItem.className = 'review-item bg-black bg-opacity-10 p-3 rounded-md';
                        reviewItem.dataset.reviewId = review.id;

                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'flex justify-between items-center mb-1';

                        const nicknameAndRating = document.createElement('div');
                        nicknameAndRating.className = 'flex items-center space-x-2'; // Added space-x-2 for spacing
                        
                        const nicknameEl = document.createElement('span');
                        nicknameEl.className = 'nickname-tag';
                        nicknameEl.textContent = review.nickname || '익명';

                        const starsEl = document.createElement('div');
                        starsEl.innerHTML = renderDisplayedStars(review.rating);

                        nicknameAndRating.appendChild(nicknameEl);
                        nicknameAndRating.appendChild(starsEl);

                        const dateAndActions = document.createElement('div');
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs theme-text-subtitle inline-block mr-2';
                        dateEl.textContent = new Date(review.created_at).toLocaleString('ko-KR');
                        dateAndActions.appendChild(dateEl);

                        // Delete button for reviews
                        if (currentUserId && review.user_id === currentUserId) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'text-xs text-red-400 hover:text-red-200 font-semibold review-delete-btn';
                            deleteBtn.textContent = '삭제';
                            deleteBtn.onclick = async (e) => {
                                e.stopPropagation();
                                await deleteReview(review.id, restaurantId, reviewsListElement, reviewSectionParent);
                            };
                            dateAndActions.appendChild(deleteBtn);
                        }

                        headerDiv.appendChild(nicknameAndRating);
                        headerDiv.appendChild(dateAndActions);

                        const textEl = document.createElement('p');
                        textEl.className = 'text-sm theme-text-body mt-2 whitespace-pre-wrap';
                        textEl.textContent = review.review_text;

                        reviewItem.appendChild(headerDiv);
                        reviewItem.appendChild(textEl);
                        reviewsListElement.appendChild(reviewItem);
                    });
                }
            } catch (err) {
                console.error('Error in fetchAndRenderReviews:', err);
                showReviewMessage(reviewSectionParent, '리뷰를 불러오는 중 예상치 못한 오류가 발생했습니다.', true);
            }
        }

        /**
         * Posts a new review for a restaurant.
         * @param {string} restaurantId - The ID of the restaurant.
         * @param {string} nickname - The nickname of the reviewer.
         * @param {number} rating - The star rating (1-5).
         * @param {string} reviewText - The review text.
         * @param {HTMLElement} reviewsListElement - The DOM element to re-render reviews into.
         * @param {HTMLElement} nicknameInput - The nickname input element to clear.
         * @param {HTMLElement} reviewTextInput - The review text input element to clear.
         * @param {HTMLElement} starsInputContainer - The stars input container to reset.
         * @param {HTMLElement} reviewSectionParent - The parent .review-section element to show messages.
         */
        async function postReview(restaurantId, nickname, rating, reviewText, reviewsListElement, nicknameInput, reviewTextInput, starsInputContainer, reviewSectionParent) {
            if (!supabase) {
                showReviewMessage(reviewSectionParent, '데이터베이스 연결 오류. 잠시 후 다시 시도해주세요.', true);
                return;
            }
            if (!reviewText || rating === 0) {
                showReviewMessage(reviewSectionParent, '별점과 한줄평을 모두 입력해주세요.', true);
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('restaurant_reviews')
                    .insert([{ 
                        restaurant_id: restaurantId, 
                        nickname: nickname || '익명', 
                        rating: rating, 
                        review_text: reviewText, 
                        user_id: currentUserId 
                    }])
                    .select();

                if (error) {
                    console.error('Error posting review:', error);
                    showReviewMessage(reviewSectionParent, `리뷰 등록 실패: ${error.message}`, true);
                } else {
                    nicknameInput.value = '';
                    reviewTextInput.value = '';
                    renderStarRatingInput(starsInputContainer, restaurantId); // Reset stars
                    showReviewMessage(reviewSectionParent, '리뷰가 성공적으로 등록되었습니다!', false);
                    await fetchAndRenderReviews(restaurantId, reviewsListElement, reviewSectionParent); // Re-render reviews
                }
            } catch (err) {
                console.error('Error in postReview:', err);
                showReviewMessage(reviewSectionParent, '리뷰 등록 중 예상치 못한 오류가 발생했어요. 잠시 후 다시 시도해주세요.', true);
            }
        }

        /**
         * Deletes a review.
         * @param {string} reviewId - The ID of the review to delete.
         * @param {string} restaurantId - The ID of the restaurant (for re-rendering).
         * @param {HTMLElement} reviewsListElement - The DOM element to re-render reviews into.
         * @param {HTMLElement} reviewSectionParent - The parent .review-section element to show messages.
         */
        async function deleteReview(reviewId, restaurantId, reviewsListElement, reviewSectionParent) {
            if (!supabase) {
                showReviewMessage(reviewSectionParent, '데이터베이스 연결 오류. 잠시 후 다시 시도해주세요.', true);
                return;
            }
            
            const confirmed = await showCustomConfirm('정말로 이 리뷰를 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('restaurant_reviews')
                    .delete()
                    .eq('id', reviewId);

                if (error) {
                    console.error('Error deleting review:', error);
                    showReviewMessage(reviewSectionParent, `리뷰 삭제 실패: ${error.message}`, true);
                } else {
                    showReviewMessage(reviewSectionParent, '리뷰가 성공적으로 삭제되었습니다.', false);
                    await fetchAndRenderReviews(restaurantId, reviewsListElement, reviewSectionParent); // Re-render reviews
                }
            } catch (err) {
                console.error('Error in deleteReview:', err);
                showReviewMessage(reviewSectionParent, '리뷰 삭제 중 예상치 못한 오류가 발생했어요. 잠시 후 다시 시도해주세요.', true);
            }
        }

        /**
         * Creates an HTML card for a restaurant, including like/dislike buttons and counts in header.
         * @param {Object} r - The restaurant data object.
         * @param {string} pageType - The type of page ('sikdae', 'gangnam', 'pub', 'community').
         * @param {Object} interactionData - Object containing likes, dislikes, and currentUserInteraction.
         * @returns {HTMLElement} The created div element for the restaurant card.
         */
        function createRestaurantCard(r, pageType, interactionData = { likes: 0, dislikes: 0, currentUserInteraction: null }) {
            const item = document.createElement('div');
            item.className = 'theme-bg-card rounded-2xl shadow-sm cursor-pointer border theme-border';
            
            const mainInfo = document.createElement('div');
            mainInfo.className = 'p-4 flex justify-between items-center';
            
            mainInfo.innerHTML = `
                <div class="flex items-center">
                    <h3 class="font-semibold text-md theme-text-body mr-2">${r.name}</h3>
                    <p class="text-sm theme-text-strong">${r.category}</p>
                    <span class="text-xs ml-3 theme-text-subtitle">
                        <i class="fas fa-thumbs-up text-blue-400"></i> ${interactionData.likes}
                        <i class="fas fa-thumbs-down text-red-400 ml-1"></i> ${interactionData.dislikes}
                    </span>
                </div>
                <svg class="w-5 h-5 theme-text-strong transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `;
            
            const detailsInfo = document.createElement('div');
            detailsInfo.className = 'details';
            const detailsContent = document.createElement('div');
            detailsContent.className = 'px-4 border-t theme-border pt-2 pb-3';
            
            const isLiked = interactionData.currentUserInteraction === 'like';
            const isDisliked = interactionData.currentUserInteraction === 'dislike';

            const likeButtonClass = `flex items-center space-x-1 px-3 py-1 rounded-full transition duration-300 ease-in-out transform hover:scale-105 ${isLiked ? 'bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`;
            const dislikeButtonClass = `flex items-center space-x-1 px-3 py-1 rounded-full transition duration-300 ease-in-out transform hover:scale-105 ${isDisliked ? 'bg-red-700 text-white' : 'bg-red-500 hover:bg-red-600 text-white'}`;

            // --- NEW: Image Slider and Lightbox Logic ---
            const imageUrls = [];
            if (r.image_url) imageUrls.push(r.image_url);
            if (r.image_url2) imageUrls.push(r.image_url2);
            if (r.image_url3) imageUrls.push(r.image_url3);
            if (r.image_url4) imageUrls.push(r.image_url4);
            if (r.image_url5) imageUrls.push(r.image_url5);

            let imageHtml = '';
            if (imageUrls.length === 0) {
                imageHtml = `<div class="flex items-center justify-center h-64 rounded-lg bg-black bg-opacity-10">
                               <p class="theme-text-subtitle">이미지 없음</p>
                             </div>`;
            } else if (imageUrls.length === 1) {
                imageHtml = `<div class="h-64 rounded-lg bg-black bg-opacity-10">
                               <img src="${imageUrls[0]}" alt="${r.name} 이미지" class="w-full h-full object-contain rounded-lg cursor-pointer restaurant-image" data-index="0">
                             </div>`;
            } else {
                const slidesHtml = imageUrls.map((url, index) => `
                    <div class="slider-slide">
                        <img src="${url}" alt="${r.name} 이미지 ${index + 1}" class="w-full h-full object-contain rounded-lg cursor-pointer restaurant-image" data-index="${index}">
                    </div>
                `).join('');

                imageHtml = `
                    <div class="slider-container h-64 rounded-lg bg-black bg-opacity-10" data-current-slide="0">
                        <div class="slider-track h-full">
                            ${slidesHtml}
                        </div>
                        <button class="slider-btn prev">&#10094;</button>
                        <button class="slider-btn next">&#10095;</button>
                    </div>
                `;
            }


            detailsContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 py-3">
                    <!-- Left Column: Text Info -->
                    <div>
                        <div class="grid grid-cols-3 gap-y-2 text-sm">
                            <strong class="col-span-1 theme-text-strong font-bold">추천 메뉴</strong>
                            <span class="col-span-2 theme-text-body">${r.menu || '-'}</span>
                            <strong class="col-span-1 theme-text-strong font-bold">맛</strong>
                            <span class="col-span-2 theme-text-body">${r.rating || '-'}</span>
                            <strong class="col-span-1 theme-text-strong font-bold">가격대</strong>
                            <span class="col-span-2 theme-text-body">${r.price || '-'}</span>
                            ${(pageType === 'gangnam' || (pageType === 'community' && r.walkingTime)) ? `
                                <strong class="col-span-1 theme-text-strong font-bold">삼원타워 기준</strong>
                                <span class="col-span-2 theme-text-body">${r.walkingTime || '-'}</span>
                            ` : ''}
                            ${(pageType === 'pub' && r.openinghours) ? `
                                <strong class="col-span-1 theme-text-strong font-bold">영업시간</strong>
                                <span class="col-span-2 theme-text-body">${r.openinghours || '-'}</span>
                            ` : ''}
                        </div>
                        <div class="py-2">
                            <strong class="text-sm theme-text-strong font-bold">코멘트</strong>
                            <p class="mt-1 text-sm theme-text-body">${r.comment || '-'}</p>
                        </div>
                        <div class="py-2">
                            <strong class="text-sm theme-text-strong font-bold">지도</strong>
                            <a href="${r.mapLink || '#'}" target="_blank" class="mt-1 text-sm map-link block">지도에서 보기 &rarr;</a>
                        </div>
                    </div>
                    <!-- Right Column: Image -->
                    <div>
                        ${imageHtml}
                    </div>
                </div>

                <!-- Like/Dislike buttons and counts -->
                <div class="flex justify-around items-center mt-4 border-t theme-border pt-4">
                    <button class="${likeButtonClass} like-button" data-place-id="${r.id}" data-place-type="${pageType}" ${isLiked ? 'disabled' : ''}>
                        <i class="fas fa-thumbs-up"></i> <span class="like-count">${interactionData.likes}</span>
                    </button>
                    <button class="${dislikeButtonClass} dislike-button" data-place-id="${r.id}" data-place-type="${pageType}" ${isDisliked ? 'disabled' : ''}>
                        <i class="fas fa-thumbs-down"></i> <span class="dislike-count">${interactionData.dislikes}</span>
                    </button>
                </div>

                <!-- Review Section -->
                <div class="review-section mt-4 p-3 rounded-xl theme-bg-card border theme-border">
                    <h4 class="font-semibold text-md theme-text-body mb-2">리뷰 남기기</h4>
                    <input type="text" class="review-nickname-input w-full p-2 rounded-md border text-sm comment-input" placeholder="닉네임을 입력하세요...">
                    <div class="rating-input-container flex items-center mt-2 mb-2">
                        <span class="mr-2 text-sm theme-text-body">별점:</span>
                        <div class="stars-input flex" data-restaurant-id="${r.id}"></div>
                    </div>
                    <textarea class="review-text-input w-full p-2 rounded-md border text-sm comment-input" placeholder="한줄평을 남겨주세요..." rows="2"></textarea>
                    <button class="post-review-btn w-full px-4 py-2 rounded-md font-semibold text-sm comment-post-btn mt-2" data-restaurant-id="${r.id}">리뷰 등록</button>
                    <div class="review-message mt-2 text-sm text-center hidden"></div>
                    <div class="existing-reviews-toggle flex justify-between items-center cursor-pointer mt-4 border-t theme-border pt-3">
                        <h5 class="font-semibold text-sm theme-text-body">등록된 리뷰</h5>
                        <svg class="w-4 h-4 theme-text-body transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="existing-reviews-content accordion-content mt-2">
                        <div class="reviews-list space-y-2">
                            <p class="text-sm theme-text-subtitle text-center">아직 리뷰가 없습니다.</p>
                        </div>
                    </div>
                </div>
            `;
            
            detailsInfo.appendChild(detailsContent);
            
            mainInfo.addEventListener('click', async (e) => {
                detailsInfo.classList.toggle('open');
                mainInfo.querySelector('svg').classList.toggle('rotate-180');

                if (detailsInfo.classList.contains('open')) {
                    const reviewSection = detailsInfo.querySelector('.review-section');
                    const starsInputContainer = reviewSection.querySelector(`.stars-input[data-restaurant-id="${r.id}"]`);
                    if (starsInputContainer) {
                        renderStarRatingInput(starsInputContainer, r.id);
                    }
                    const reviewsListElement = reviewSection.querySelector('.reviews-list');
                    if (reviewsListElement) {
                        await fetchAndRenderReviews(r.id, reviewsListElement, reviewSection);
                    }

                    const postReviewBtn = reviewSection.querySelector(`.post-review-btn[data-restaurant-id="${r.id}"]`);
                    if (postReviewBtn) {
                        postReviewBtn.removeEventListener('click', handlePostReviewClick);
                        postReviewBtn.addEventListener('click', handlePostReviewClick);
                    }

                    const reviewsToggle = reviewSection.querySelector('.existing-reviews-toggle');
                    const reviewsContent = reviewSection.querySelector('.existing-reviews-content');
                    if (reviewsToggle && reviewsContent) {
                        reviewsContent.classList.add('open');
                        reviewsToggle.querySelector('svg').classList.add('rotate-180');
                    }
                }
            });

            const handlePostReviewClick = async (e) => {
                const restaurantId = e.target.dataset.restaurantId;
                const reviewSection = e.target.closest('.review-section');
                const nicknameInput = reviewSection.querySelector('.review-nickname-input');
                const reviewTextInput = reviewSection.querySelector('.review-text-input');
                const starsInputContainer = reviewSection.querySelector('.stars-input');
                const reviewsListElement = reviewSection.querySelector('.reviews-list');

                const nickname = nicknameInput.value.trim();
                const reviewText = reviewTextInput.value.trim();
                const rating = parseInt(starsInputContainer.dataset.currentRating || 0);

                await postReview(restaurantId, nickname, rating, reviewText, reviewsListElement, nicknameInput, reviewTextInput, starsInputContainer, reviewSection);
            };

            item.appendChild(mainInfo);
            item.appendChild(detailsInfo);

            const reviewSection = detailsInfo.querySelector('.review-section');
            const reviewsToggle = reviewSection.querySelector('.existing-reviews-toggle');
            const reviewsContent = reviewSection.querySelector('.existing-reviews-content');

            if (reviewsToggle && reviewsContent) {
                reviewsToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    reviewsContent.classList.toggle('open');
                    reviewsToggle.querySelector('svg').classList.toggle('rotate-180');
                });
            }

            const likeButton = item.querySelector('.like-button');
            const dislikeButton = item.querySelector('.dislike-button');

            if (likeButton) {
                likeButton.addEventListener('click', () => handleInteraction(likeButton, 'like'));
            }
            if (dislikeButton) {
                dislikeButton.addEventListener('click', () => handleInteraction(dislikeButton, 'dislike'));
            }

            return item;
        }

        /**
         * Renders the restaurant list based on filters and sort order.
         * This function now also fetches and passes interaction data.
         * @param {HTMLElement} sectionsElement - The DOM element to render sections into.
         * @param {Array<Object>} data - The raw restaurant data for the current tab.
         * @param {Array<string>} categoryOrder - The preferred order of categories.
         * @param {string} pageType - The type of page ('sikdae', 'gangnam', or 'pub').
         * @param {string} searchTerm - The current search input value.
         * @param {string} priceFilter - The selected price filter value.
         * @param {string} sortOrder - The selected sort order.
         */
        async function renderRestaurantList(sectionsElement, data, categoryOrder, pageType, searchTerm = '', priceFilter = 'all', sortOrder = 'category') {
            let filteredData = data;

            // 1. Apply Search Filter
            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredData = filteredData.filter(r => 
                    (r.name && r.name.toLowerCase().includes(lowerCaseSearchTerm)) || 
                    (r.menu && r.menu.toLowerCase().includes(lowerCaseSearchTerm)) || 
                    (r.category && r.category.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    (r.comment && r.comment.toLowerCase().includes(lowerCaseSearchTerm))
                );
            }

            // 2. Apply Price Filter
            if (priceFilter !== 'all') {
                filteredData = filteredData.filter(r => {
                    const priceRange = parsePriceStringForRange(r.price);
                    let minPrice = priceRange.min;
                    let maxPrice = priceRange.max;

                    switch (priceFilter) {
                        case 'under-10000': return maxPrice < 10000;
                        case '10000-20000': return minPrice >= 10000 && maxPrice < 20000;
                        case '20000-30000': return minPrice >= 20000 && maxPrice < 30000;
                        case 'over-30000': return minPrice >= 30000;
                        // Pub specific price filters
                        case 'under-20000': return maxPrice < 20000;
                        case '20000-40000': return minPrice >= 20000 && maxPrice < 40000;
                        case 'over-40000': return minPrice >= 40000;
                        default: return true;
                    }
                });
            }

            // 3. Apply Sorting
            let sortedData = [...filteredData]; // Create a copy to sort
            if (sortOrder === 'name-asc') {
                sortedData.sort((a, b) => a.name.localeCompare(b.name, 'ko-KR'));
            }
            // If sortOrder is 'category', we will rely on the grouping logic below.

            sectionsElement.innerHTML = '';
            
            // Fetch interactions for all filtered restaurants
            const placeIds = sortedData.map(r => r.id);
            let interactionsMap = new Map(); // Map to store interaction counts and user's interaction
            if (placeIds.length > 0) {
                const { data: interactions, error: interactionsError } = await supabase
                    .from('user_place_interactions')
                    .select('*')
                    .in('place_id', placeIds)
                    .eq('place_type', pageType); // Filter by place_type

                if (interactionsError) {
                    console.error('Error fetching interactions:', interactionsError.message);
                } else {
                    interactions.forEach(interaction => {
                        if (!interactionsMap.has(interaction.place_id)) {
                            interactionsMap.set(interaction.place_id, { likes: 0, dislikes: 0, currentUserInteraction: null });
                        }
                        const currentCounts = interactionsMap.get(interaction.place_id);
                        if (interaction.interaction_type === 'like') {
                            currentCounts.likes++;
                        } else if (interaction.interaction_type === 'dislike') {
                            currentCounts.dislikes++;
                        }
                        if (currentUserId && interaction.user_id === currentUserId) {
                            currentCounts.currentUserInteraction = interaction.interaction_type;
                        }
                    });
                }
            }


            // Grouping for 'category' sort or default display
            const grouped = sortedData.reduce((acc, restaurant) => {
                const groupName = restaurant.category || '기타'; 
                if (!acc[groupName]) acc[groupName] = [];
                acc[groupName].push(restaurant);
                return acc;
            }, {});

            console.log('Grouped data for rendering:', grouped);

            // Render based on category order, and sort within categories if 'name-asc' is selected
            categoryOrder.forEach(categoryName => {
                let restaurantsInGroup = grouped[categoryName];
                
                if (restaurantsInGroup && restaurantsInGroup.length > 0) {
                    // If sorting by name-asc, sort within each category group as well
                    if (sortOrder === 'name-asc') {
                        restaurantsInGroup.sort((a, b) => a.name.localeCompare(b.name, 'ko-KR'));
                    }

                    const sectionWrapper = document.createElement('div');
                    sectionWrapper.className = 'theme-bg-header rounded-2xl shadow-lg overflow-hidden';
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'p-4 md:p-5 flex justify-between items-center cursor-pointer';
                    
                    // Removed like/dislike counts from the category header
                    categoryHeader.innerHTML = `
                        <div class="flex items-center">
                            <h2 class="text-xl md:text-2xl font-bold theme-text-header">${categoryName}</h2>
                        </div>
                        <svg class="w-5 h-5 md:w-6 md:h-6 theme-text-header transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;
                    
                    const listContainer = document.createElement('div');
                    listContainer.className = 'accordion-content';
                    const innerList = document.createElement('div');
                    innerList.className = 'space-y-3 p-3 md:p-4 border-t theme-border';
                    
                    restaurantsInGroup.forEach(r => {
                        const interactionData = interactionsMap.get(r.id) || { likes: 0, dislikes: 0, currentUserInteraction: null };
                        const card = createRestaurantCard(r, pageType, interactionData);
                        card.classList.add('card-enter'); // Add animation class
                        innerList.appendChild(card);
                    });
                    listContainer.appendChild(innerList);
                    categoryHeader.addEventListener('click', () => {
                        listContainer.classList.toggle('open');
                        categoryHeader.querySelector('svg').classList.toggle('rotate-180');
                    });
                    sectionWrapper.appendChild(categoryHeader);
                    sectionWrapper.appendChild(listContainer);
                    sectionsElement.appendChild(sectionWrapper);
                } else {
                    console.log(`No restaurants found for category: ${categoryName} after filtering.`);
                }
            });

            // If no restaurants match filters, display a message
            if (sectionsElement.innerHTML === '') {
                sectionsElement.innerHTML = '<p class="text-center text-lg theme-text-subtitle mt-8">검색 결과가 없습니다. 다른 필터나 검색어를 시도해보세요.</p>';
            }
        }

        /**
         * Handles like/dislike interaction for a place.
         * @param {HTMLElement} button - The clicked like or dislike button.
         * @param {string} interactionType - 'like' or 'dislike'.
         */
        async function handleInteraction(button, interactionType) {
            if (!currentUserId) {
                showMessageBox('로그인이 필요합니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            const placeId = button.dataset.placeId;
            const placeType = button.dataset.placeType; // e.g., 'sikdae', 'gangnam', 'pub'

            try {
                // Check if user already interacted with this place
                const { data: existingInteraction, error: fetchError } = await supabase
                    .from('user_place_interactions')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('place_id', placeId)
                    .eq('place_type', placeType)
                    .single(); // Expects one or zero records

                if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 means no rows found, which is fine
                    throw fetchError;
                }

                if (existingInteraction) {
                    // User has already interacted with this place
                    if (existingInteraction.interaction_type === interactionType) {
                        // If trying to do the same interaction again, remove the interaction (undo)
                        const confirmed = await showCustomConfirm(`이미 ${interactionType === 'like' ? '추천' : '비추천'}하셨습니다. ${interactionType === 'like' ? '추천' : '비추천'}을 취소하시겠습니까?`);
                        if (!confirmed) return;

                        const { error: deleteError } = await supabase
                            .from('user_place_interactions')
                            .delete()
                            .eq('id', existingInteraction.id);

                        if (deleteError) throw deleteError;
                        showMessageBox(`${interactionType === 'like' ? '추천' : '비추천'}이 취소되었습니다.`, 'success');
                    } else {
                        // Changing interaction type (e.g., from like to dislike, or vice-versa)
                        const confirmed = await showCustomConfirm(`이미 ${existingInteraction.interaction_type === 'like' ? '추천' : '비추천'}하셨습니다. ${interactionType === 'like' ? '추천' : '비추천'}으로 변경하시겠습니까?`);
                        if (!confirmed) return;

                        const { error: updateError } = await supabase
                            .from('user_place_interactions')
                            .update({ interaction_type: interactionType, created_at: new Date().toISOString() })
                            .eq('id', existingInteraction.id);

                        if (updateError) throw updateError;
                        showMessageBox(`성공적으로 ${interactionType === 'like' ? '추천' : '비추천'}으로 변경되었습니다!`, 'success');
                    }
                } else {
                    // New interaction for this user and place
                    const { error: insertError } = await supabase
                        .from('user_place_interactions')
                        .insert({
                            user_id: currentUserId,
                            place_id: placeId,
                            place_type: placeType,
                            interaction_type: interactionType
                        });

                    if (insertError) throw insertError;
                    showMessageBox(`성공적으로 ${interactionType === 'like' ? '추천' : '비추천'}되었습니다!`, 'success');
                }

                // After successful interaction, refresh the relevant list to update counts and button states
                if (placeType === 'sikdae') {
                    updateSikdaeList();
                } else if (placeType === 'gangnam') {
                    updateGangnamList();
                } else if (placeType === 'pub') {
                    updatePubList();
                }

            } catch (error) {
                console.error('Error handling interaction:', error.message);
                showMessageBox(`오류 발생: ${error.message}`, 'error');
            }
        }


        // ==================== Tab Switching Logic ====================
        let currentMainTab = 'community'; // Default main tab
        let currentSubTab = 'sikdae'; // Default sub tab for integrated map

        function switchSubTab(subTab) {
            currentSubTab = subTab;
            
            // Set theme based on the active sub-tab
            let themeForSubTab;
            if (subTab === 'sikdae') {
                themeForSubTab = 'sikdae';
            } else if (subTab === 'gangnam') {
                themeForSubTab = 'gangnam';
            } else if (subTab === 'pub') {
                themeForSubTab = 'pub';
            }
            document.body.className = `theme-${themeForSubTab}`;
            // Reapply aurora mode if it was enabled
            if (localStorage.getItem('auroraModeEnabled') === 'true') {
                document.body.classList.add('aurora-mode');
            }

            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subTab === subTab);
            });
            document.querySelectorAll('.sub-page-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `${subTab}-sub-content`);
            });

            // Re-render content for the newly active sub-tab with current filters/sorts
            if (subTab === 'sikdae') {
                const sikdaeSearchInput = document.getElementById('sikdae-search-input');
                const sikdaePriceFilter = document.getElementById('sikdae-price-filter');
                const sikdaeSortOrder = document.getElementById('sikdae-sort-order');
                renderRestaurantList(
                    document.getElementById('sikdae-restaurant-sections'), 
                    allRestaurantsData.filter(r => r.source_tab === 'sikdae'), 
                    sikdaeCategoryOrder, 
                    'sikdae', 
                    sikdaeSearchInput.value, 
                    sikdaePriceFilter.value, 
                    sikdaeSortOrder.value
                );
            } else if (subTab === 'gangnam') {
                const gangnamSearchInput = document.getElementById('gangnam-search-input');
                const gangnamPriceFilter = document.getElementById('gangnam-price-filter');
                const gangnamSortOrder = document.getElementById('gangnam-sort-order');
                renderRestaurantList(
                    document.getElementById('gangnam-restaurant-sections'), 
                    allRestaurantsData.filter(r => r.source_tab === 'gangnam'), 
                    gangnamCategoryOrder, 
                    'gangnam', 
                    gangnamSearchInput.value, 
                    gangnamPriceFilter.value, 
                    gangnamSortOrder.value
                );
            } else if (subTab === 'pub') {
                const pubSearchInput = document.getElementById('pub-search-input');
                const pubPriceFilter = document.getElementById('pub-price-filter');
                const pubSortOrder = document.getElementById('pub-sort-order');
                renderRestaurantList(
                    document.getElementById('pub-restaurant-sections'), 
                    allRestaurantsData.filter(r => r.source_tab === 'pub'),
                    pubCategoryOrder, 
                    'pub', 
                    pubSearchInput.value, 
                    pubPriceFilter.value, 
                    pubSortOrder.value
                );
            }
        }

        function switchTab(mainTab) {
            currentMainTab = mainTab;
            // Determine theme based on the main tab or default sub-tab if integrated map
            let theme = 'community'; // Default theme for community tab
            if (mainTab === 'integrated-map') {
                // If switching to integrated map, apply the theme of the current sub-tab
                // This ensures consistency when switching from community to integrated map
                if (currentSubTab === 'sikdae') {
                    theme = 'sikdae';
                } else if (currentSubTab === 'gangnam') {
                    theme = 'gangnam';
                } else if (currentSubTab === 'pub') {
                    theme = 'pub';
                }
            }
            document.body.className = `theme-${theme}`;
            // Apply aurora mode class if enabled
            if (localStorage.getItem('auroraModeEnabled') === 'true') {
                document.body.classList.add('aurora-mode');
            }

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === mainTab);
            });
            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `${mainTab}-content`);
            });

            if (mainTab === 'integrated-map') {
                // When switching to integrated map, activate the default sub-tab
                switchSubTab(currentSubTab); // Will default to 'sikdae' if not set
            }
        }
        
        // ==================== Aurora Mode Toggle Logic ====================
        const auroraToggleBtn = document.getElementById('aurora-toggle-btn');

        function applyAuroraMode(isEnabled) {
            if (isEnabled) {
                document.body.classList.add('aurora-mode');
                auroraToggleBtn.textContent = '🎨'; // Palette icon for solid mode
            } else {
                document.body.classList.remove('aurora-mode');
                auroraToggleBtn.textContent = '✨'; // Sparkle icon for aurora mode
            }
        }

        auroraToggleBtn.addEventListener('click', () => {
            const isEnabled = document.body.classList.toggle('aurora-mode');
            localStorage.setItem('auroraModeEnabled', isEnabled);
            applyAuroraMode(isEnabled);
        });

        // ==================== Lightbox Functions ====================
        function openLightbox(images, index) {
            currentLightboxImages = images;
            currentLightboxIndex = index;
            updateLightboxImage();
            lightbox.classList.remove('hidden');
        }

        function closeLightbox() {
            lightbox.classList.add('hidden');
        }

        function updateLightboxImage() {
            if (currentLightboxImages.length > 0) {
                lightboxImage.src = currentLightboxImages[currentLightboxIndex];
            }
            lightboxPrev.style.display = currentLightboxImages.length > 1 ? 'block' : 'none';
            lightboxNext.style.display = currentLightboxImages.length > 1 ? 'block' : 'none';
        }

        function showPrevLightboxImage() {
            currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
            updateLightboxImage();
        }

        function showNextLightboxImage() {
            currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
            updateLightboxImage();
        }


        // ==================== Notification Logic ====================
        const notificationBellContainer = document.querySelector('.notification-bell-container');
        const notificationCountSpan = document.getElementById('notification-count');
        const notificationPanel = document.getElementById('notification-panel');
        const notificationListContent = document.getElementById('notification-list-content');
        const clearAllNotificationsBtn = document.getElementById('clear-all-notifications-btn');

        let readNotificationIds = {};

        function loadReadStatus() {
            if (currentUserId) {
                const storedStatus = localStorage.getItem(`readNotifications_${currentUserId}`);
                readNotificationIds = storedStatus ? JSON.parse(storedStatus) : {};
            } else {
                readNotificationIds = {};
            }
        }

        function saveReadStatus() {
            if (currentUserId) {
                localStorage.setItem(`readNotifications_${currentUserId}`, JSON.stringify(readNotificationIds));
            }
        }

        async function updateNotificationCount() {
            if (!supabase) return;
            try {
                const { data: notifications, error } = await supabase.from('notifications').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                const unreadNotifications = notifications.filter(notif => !readNotificationIds[notif.id]);
                const count = unreadNotifications.length;
                notificationCountSpan.textContent = count;
                notificationCountSpan.classList.toggle('hidden', count === 0);
                renderNotifications(notifications);
            } catch (err) {
                console.error('Error in updateNotificationCount:', err);
            }
        }

        function renderNotifications(notifications) {
            notificationListContent.innerHTML = '';
            const unreadNotifications = notifications.filter(notif => !readNotificationIds[notif.id]);
            if (unreadNotifications.length === 0) {
                notificationListContent.innerHTML = '<p class="text-center text-sm theme-text-subtitle py-4">새로운 알림이 없습니다.</p>';
                return;
            }
            unreadNotifications.forEach(notif => {
                const item = document.createElement('div');
                item.className = `notification-item unread`;
                item.dataset.notificationId = notif.id;
                item.dataset.boardType = notif.board_type;
                const timeAgo = new Date(notif.created_at).toLocaleString('ko-KR');
                item.innerHTML = `
                    <p class="notification-item-text theme-text-body">
                        <span class="font-semibold">${notif.commenter_nickname || '익명'}</span>님이 
                        <span class="font-semibold">${notif.board_type === 'restaurant_comments' ? '맛집 추천 게시판' : '자유 게시판'}</span>에 댓글을 남겼습니다:
                        "${notif.comment_text.substring(0, 30)}${notif.comment_text.length > 30 ? '...' : ''}"
                    </p>
                    <p class="notification-item-time">${timeAgo}</p>
                `;
                item.addEventListener('click', () => handleNotificationClick(notif.id, notif.board_type));
                notificationListContent.appendChild(item);
            });
        }

        async function handleNotificationClick(notificationId, boardType) {
            notificationPanel.classList.remove('open');
            if (!readNotificationIds[notificationId]) {
                readNotificationIds[notificationId] = true;
                saveReadStatus();
                updateNotificationCount();
            }
            switchTab('community');
            const targetToggleBtn = document.getElementById(boardType === 'restaurant_comments' ? 'toggle-restaurant-comments' : 'toggle-general-comments');
            const targetContainer = document.getElementById(boardType === 'restaurant_comments' ? 'restaurant-comments-container' : 'general-comments-container');
            if (targetToggleBtn && targetContainer) {
                if (!targetContainer.classList.contains('open')) {
                    targetToggleBtn.click();
                }
                targetToggleBtn.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        async function deleteAllNotifications() {
            if (!supabase) return;
            const confirmed = await showCustomConfirm('모든 알림을 삭제하시겠습니까?');
            if (!confirmed) return;
            try {
                const { error } = await supabase.from('notifications').delete().not('id', 'is', null);
                if (error) throw error;
                localStorage.removeItem(`readNotifications_${currentUserId}`);
                readNotificationIds = {};
                updateNotificationCount();
                notificationPanel.classList.remove('open');
            } catch (err) {
                console.error('Error deleting all notifications:', err);
                showCustomConfirm('알림 삭제 중 오류가 발생했습니다.');
            }
        }

        // ==================== Special Day Banner Logic ====================
        const specialDayBanner = document.getElementById('special-day-banner');
        const specialDayText = document.getElementById('special-day-text');

        async function fetchSpecialDay() {
            if (!supabase) return;
            try {
                const today = new Date();
                const todayMonthDay = `${today.getMonth() + 1}.${today.getDate()}`;
                const { data: todayData, error: todayError } = await supabase.from('special_days').select('*').eq('date_md', todayMonthDay).limit(1);
                if (todayError) throw todayError;

                if (todayData && todayData.length > 0) {
                    const day = todayData[0];
                    const desc = day.description ? ` ${day.description.replace(/[()]/g, '')}` : '';
                    specialDayText.innerHTML = `오늘은 <b>[${day.title}]</b>${desc}!`;
                    specialDayBanner.classList.remove('hidden');
                } else {
                    const { data: allDays, error: allDaysError } = await supabase.from('special_days').select('*');
                    if (allDaysError) throw allDaysError;
                    
                    let nextSpecialDay = null;
                    let minTimeDiff = Infinity;
                    const nowTime = today.getTime();
                    const currentYear = today.getFullYear();

                    for (const day of allDays) {
                        const [month, date] = day.date_md.split('.').map(Number);
                        if (isNaN(month) || isNaN(date)) continue;
                        
                        let dateThisYear = new Date(currentYear, month - 1, date);
                        let candidateDate = (dateThisYear.getTime() >= nowTime) ? dateThisYear : new Date(currentYear + 1, month - 1, date);
                        let timeDiff = candidateDate.getTime() - nowTime;

                        if (timeDiff >= 0 && timeDiff < minTimeDiff) {
                            minTimeDiff = timeDiff;
                            nextSpecialDay = { ...day, fullDate: candidateDate };
                        }
                    }

                    if (nextSpecialDay) {
                        const nextDate = nextSpecialDay.fullDate;
                        const formattedNextDate = `${nextDate.getMonth() + 1}월 ${nextDate.getDate()}일`;
                        const desc = nextSpecialDay.description ? ` ${nextSpecialDay.description.replace(/[()]/g, '')}` : '';
                        specialDayText.innerHTML = `다음 기념일은 ${formattedNextDate} <b>[${nextSpecialDay.title}]</b>${desc}!`;
                        specialDayBanner.classList.remove('hidden');
                    } else {
                        specialDayText.textContent = '다음 기념일을 준비 중이에요.';
                        specialDayBanner.classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error('Error in fetchSpecialDay:', err);
                specialDayBanner.classList.add('hidden');
            }
        }

        function scheduleDailySpecialDayUpdate() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setDate(now.getDate() + 1);
            midnight.setHours(0, 0, 0, 0);
            const timeToMidnight = midnight.getTime() - now.getTime();
            setTimeout(() => {
                fetchSpecialDay();
                scheduleDailySpecialDayUpdate();
            }, timeToMidnight);
        }

        // ==================== Page Initialization ====================
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!supabase) {
                document.getElementById('community-content').innerHTML = `<div class="text-center p-8 theme-bg-header rounded-lg shadow-lg"><h2 class="text-2xl font-bold theme-text-header mb-4">Supabase 연결 오류</h2><p class="theme-text-subtitle">Supabase URL 또는 키를 확인해주세요.</p></div>`;
                return;
            }

            // --- Menu Logic ---
            const menuContainer = document.getElementById('menu-container');
            const menuPanel = document.getElementById('menu-panel');
            const mainTabButtons = document.querySelectorAll('.tab-btn');
            const subTabButtons = document.querySelectorAll('.sub-tab-btn');

            menuContainer.addEventListener('mouseenter', () => {
                menuPanel.classList.add('open');
            });
            menuContainer.addEventListener('mouseleave', () => {
                menuPanel.classList.remove('open');
            });

            mainTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                    menuPanel.classList.remove('open'); // Close menu after selection
                });
            });
            
            subTabButtons.forEach(btn => {
                btn.addEventListener('click', () => switchSubTab(btn.dataset.subTab));
            });


            // Initial aurora mode application
            const savedAuroraMode = localStorage.getItem('auroraModeEnabled') === 'true';
            applyAuroraMode(savedAuroraMode);

            // --- Lightbox Initialization ---
            lightbox = document.getElementById('image-lightbox');
            lightboxImage = document.getElementById('lightbox-image');
            lightboxClose = document.getElementById('lightbox-close');
            lightboxPrev = document.getElementById('lightbox-prev');
            lightboxNext = document.getElementById('lightbox-next');

            lightboxClose.addEventListener('click', closeLightbox);
            lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
            lightboxPrev.addEventListener('click', showPrevLightboxImage);
            lightboxNext.addEventListener('click', showNextLightboxImage);

            // --- User Auth ---
            let { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                const { data: signInData } = await supabase.auth.signInAnonymously();
                user = signInData?.user;
            }
            currentUserId = user?.id;
            console.log('Current User ID:', currentUserId);

            loadReadStatus();
            updateNotificationCount();

            // --- Notification Bell Interaction ---
            notificationBellContainer.addEventListener('click', () => {
                notificationPanel.classList.toggle('open');
                if (notificationPanel.classList.contains('open')) updateNotificationCount();
            });
            document.addEventListener('click', (event) => {
                if (!notificationBellContainer.contains(event.target) && !notificationPanel.contains(event.target)) {
                    notificationPanel.classList.remove('open');
                }
            });
            clearAllNotificationsBtn.addEventListener('click', deleteAllNotifications);

            // Initial fetch for special day banner
            await fetchSpecialDay();
            scheduleDailySpecialDayUpdate();

            // --- Fetch restaurant data ---
            async function fetchAllRestaurantData() {
                try {
                    const { data, error } = await supabase.from('restaurants').select('*').order('created_at', { ascending: false });
                    if (error) throw error;
                    return data;
                } catch (err) {
                    console.error('Error fetching restaurant data:', err);
                    return [];
                }
            }
            allRestaurantsData = await fetchAllRestaurantData();

            // --- Sikdae Sub-Page Initialization ---
            const sikdaeSectionsElement = document.getElementById('sikdae-restaurant-sections');
            const sikdaeSearchInput = document.getElementById('sikdae-search-input');
            const sikdaePriceFilter = document.getElementById('sikdae-price-filter');
            const sikdaeSortOrder = document.getElementById('sikdae-sort-order');
            const sikdaeAiBtn = document.getElementById('sikdae-ai-recommend-btn');
            const sikdaeAiPrompt = document.getElementById('sikdae-ai-prompt-input');
            const sikdaeAiResult = document.getElementById('sikdae-ai-result-container');
            
            const updateSikdaeList = () => renderRestaurantList(sikdaeSectionsElement, allRestaurantsData.filter(r => r.source_tab === 'sikdae'), sikdaeCategoryOrder, 'sikdae', sikdaeSearchInput.value, sikdaePriceFilter.value, sikdaeSortOrder.value);
            sikdaeSearchInput.addEventListener('input', updateSikdaeList);
            sikdaePriceFilter.addEventListener('change', updateSikdaeList);
            sikdaeSortOrder.addEventListener('change', updateSikdaeList);
            sikdaeAiBtn.addEventListener('click', () => getAiRecommendation(sikdaeAiPrompt.value, allRestaurantsData.filter(r => r.source_tab === 'sikdae'), sikdaeAiResult, sikdaeAiBtn));
            sikdaeAiPrompt.addEventListener('keyup', (e) => { if (e.key === 'Enter') sikdaeAiBtn.click(); });

            // --- Gangnam Sub-Page Initialization ---
            const gangnamSectionsElement = document.getElementById('gangnam-restaurant-sections');
            const gangnamSearchInput = document.getElementById('gangnam-search-input');
            const gangnamPriceFilter = document.getElementById('gangnam-price-filter');
            const gangnamSortOrder = document.getElementById('gangnam-sort-order');
            const gangnamAiBtn = document.getElementById('gangnam-ai-recommend-btn');
            const gangnamAiPrompt = document.getElementById('gangnam-ai-prompt-input');
            const gangnamAiResult = document.getElementById('gangnam-ai-result-container');
            
            const updateGangnamList = () => renderRestaurantList(gangnamSectionsElement, allRestaurantsData.filter(r => r.source_tab === 'gangnam'), gangnamCategoryOrder, 'gangnam', gangnamSearchInput.value, gangnamPriceFilter.value, gangnamSortOrder.value);
            gangnamSearchInput.addEventListener('input', updateGangnamList);
            gangnamPriceFilter.addEventListener('change', updateGangnamList);
            gangnamSortOrder.addEventListener('change', updateGangnamList);
            gangnamAiBtn.addEventListener('click', () => getAiRecommendation(gangnamAiPrompt.value, allRestaurantsData.filter(r => r.source_tab === 'gangnam'), gangnamAiResult, gangnamAiBtn));
            gangnamAiPrompt.addEventListener('keyup', (e) => { if (e.key === 'Enter') gangnamAiBtn.click(); });

            // --- Pub Sub-Page Initialization ---
            const pubSectionsElement = document.getElementById('pub-restaurant-sections');
            const pubSearchInput = document.getElementById('pub-search-input');
            const pubPriceFilter = document.getElementById('pub-price-filter');
            const pubSortOrder = document.getElementById('pub-sort-order');
            const pubAiBtn = document.getElementById('pub-ai-recommend-btn');
            const pubAiPrompt = document.getElementById('pub-ai-prompt-input');
            const pubAiResult = document.getElementById('pub-ai-result-container');

            const updatePubList = () => renderRestaurantList(pubSectionsElement, allRestaurantsData.filter(r => r.source_tab === 'pub'), pubCategoryOrder, 'pub', pubSearchInput.value, pubPriceFilter.value, pubSortOrder.value);
            pubSearchInput.addEventListener('input', updatePubList);
            pubPriceFilter.addEventListener('change', updatePubList);
            pubSortOrder.addEventListener('change', updatePubList);
            pubAiBtn.addEventListener('click', () => getAiRecommendation(pubAiPrompt.value, allRestaurantsData.filter(r => r.source_tab === 'pub'), pubAiResult, pubAiBtn));
            pubAiPrompt.addEventListener('keyup', (e) => { if (e.key === 'Enter') pubAiBtn.click(); });

            // --- Community Page Initialization ---
            const communityDrawBtn = document.getElementById('community-draw-btn');
            const communityResultContainer = document.getElementById('community-result-container');
            communityDrawBtn.addEventListener('click', () => {
                communityDrawBtn.disabled = true;
                communityResultContainer.innerHTML = '<p class="text-lg theme-text-subtitle col-span-2 text-center">오늘의 운명을 뽑는 중... 🎲</p>';
                setTimeout(() => {
                    communityResultContainer.innerHTML = '';
                    const restaurantsForDraw = allRestaurantsData.filter(item => item.source_tab !== 'pub');
                    const uniqueData = Array.from(new Map(restaurantsForDraw.map(item => [item.id, item])).values());
                    const selected = [...uniqueData].sort(() => 0.5 - Math.random()).slice(0, 2);
                    selected.forEach((r, index) => {
                        const card = createRestaurantCard(r, 'community'); 
                        card.style.animationDelay = `${index * 0.1}s`;
                        card.classList.add('card-enter');
                        communityResultContainer.appendChild(card);
                    });
                    communityDrawBtn.disabled = false;
                }, 1000);
            });
            
            // --- Comment Section Initialization ---
            const toggleRestaurantBtn = document.getElementById('toggle-restaurant-comments');
            const restaurantCommentsContainer = document.getElementById('restaurant-comments-container');
            restaurantCommentList = document.getElementById('restaurant-comment-list');
            restaurantNicknameInput = document.getElementById('restaurant-nickname-input');
            const restaurantCommentInput = document.getElementById('restaurant-comment-input');
            const restaurantCommentPostBtn = document.getElementById('restaurant-comment-post-btn');

            const toggleGeneralBtn = document.getElementById('toggle-general-comments');
            const generalCommentsContainer = document.getElementById('general-comments-container');
            generalCommentList = document.getElementById('general-comment-list');
            generalNicknameInput = document.getElementById('general-nickname-input');
            const generalCommentInput = document.getElementById('general-comment-input');
            const generalCommentPostBtn = document.getElementById('general-comment-post-btn');

            function buildCommentTree(comments) {
                const commentMap = new Map();
                const rootComments = [];
                comments.forEach(c => commentMap.set(c.id, { ...c, replies: [] }));
                comments.forEach(c => {
                    if (c.parent_id && commentMap.has(c.parent_id)) {
                        commentMap.get(c.parent_id).replies.push(commentMap.get(c.id));
                    } else {
                        rootComments.push(commentMap.get(c.id));
                    }
                });
                rootComments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                rootComments.forEach(c => c.replies.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)));
                return rootComments;
            }

            function renderComment(comment, container, isReply = false) {
                const item = document.createElement('div');
                item.className = `comment-item ${isReply ? 'reply-item' : ''}`;
                item.dataset.commentId = comment.id;
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="nickname-tag">${comment.nickname || '익명'}</span>
                            <p class="text-xs theme-text-subtitle">${new Date(comment.created_at).toLocaleString('ko-KR')}</p>
                        </div>
                        <div class="actions"></div>
                    </div>
                    <p class="text-sm theme-text-body whitespace-pre-wrap">${comment.text}</p>
                `;
                const actionsDiv = item.querySelector('.actions');
                if (!isReply) {
                    const replyBtn = document.createElement('button');
                    replyBtn.className = 'text-xs text-blue-400 hover:text-blue-200 font-semibold ml-2 reply-btn';
                    replyBtn.textContent = '답글';
                    replyBtn.onclick = (e) => {
                        e.stopPropagation();
                        const form = item.querySelector('.reply-form-container');
                        if (form) {
                            form.classList.toggle('open');
                            if (form.classList.contains('open')) {
                                form.querySelector('.reply-nickname-input').value = '';
                                form.querySelector('textarea').focus();
                            }
                        }
                    };
                    actionsDiv.appendChild(replyBtn);
                }
                if (currentUserId && comment.user_id === currentUserId) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-xs text-red-400 hover:text-red-200 font-semibold ml-2 comment-delete-btn';
                    deleteBtn.textContent = '삭제';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteComment(comment.id, comment.board_type); };
                    actionsDiv.appendChild(deleteBtn);
                }
                if (!isReply) {
                    const replyForm = document.createElement('div');
                    replyForm.className = 'reply-form-container mt-3 p-3 rounded-md theme-bg-card border theme-border';
                    replyForm.innerHTML = `
                        <input type="text" class="reply-nickname-input w-full p-2 rounded-md border text-sm comment-input" placeholder="닉네임을 입력하세요...">
                        <textarea class="reply-text-input w-full p-2 rounded-md border text-sm comment-input mt-2" placeholder="답글을 남겨주세요..." rows="2"></textarea>
                        <button type="button" class="post-reply-btn w-full px-4 py-2 rounded-md font-semibold text-sm comment-post-btn mt-2">답글 등록</button>
                    `;
                    const postReplyBtn = replyForm.querySelector('.post-reply-btn');
                    postReplyBtn.addEventListener('click', async () => {
                        await postBoardComment(comment.board_type, replyForm.querySelector('.reply-nickname-input'), replyForm.querySelector('.reply-text-input'), comment.id);
                        replyForm.classList.remove('open');
                    });
                    item.appendChild(replyForm);
                }
                if (comment.replies && comment.replies.length > 0) {
                    const repliesContainer = document.createElement('div');
                    repliesContainer.className = 'replies-container mt-3 space-y-2';
                    const repliesToggle = document.createElement('div');
                    repliesToggle.className = 'flex justify-between items-center cursor-pointer text-sm theme-text-subtitle py-2';
                    repliesToggle.innerHTML = `<span>답글 ${comment.replies.length}개 보기</span><svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                    repliesToggle.onclick = () => {
                        repliesContainer.classList.toggle('open');
                        repliesToggle.querySelector('svg').classList.toggle('rotate-180');
                        repliesToggle.querySelector('span').textContent = repliesContainer.classList.contains('open') ? `답글 ${comment.replies.length}개 숨기기` : `답글 ${comment.replies.length}개 보기`;
                    };
                    comment.replies.forEach(reply => renderComment(reply, repliesContainer, true));
                    item.appendChild(repliesContainer);
                    item.appendChild(repliesToggle);
                }
                container.appendChild(item);
            }

            async function deleteComment(commentId, boardType) {
                if (!(await showCustomConfirm('정말로 이 댓글을 삭제하시겠습니까?'))) return;
                const { error } = await supabase.from('comments').delete().eq('id', commentId);
                if (error) console.error('Error deleting comment:', error);
                else {
                    await supabase.from('notifications').delete().eq('comment_id', commentId);
                    if (boardType === 'restaurant_comments') fetchAndRenderBoardComments('restaurant_comments', restaurantCommentList);
                    else if (boardType === 'general_comments') fetchAndRenderBoardComments('general_comments', generalCommentList);
                    updateNotificationCount();
                }
            }

            const fetchAndRenderBoardComments = async (boardType, listEl) => {
                const { data, error } = await supabase.from('comments').select('*').eq('board_type', boardType).order('created_at', { ascending: true });
                if (error) {
                    listEl.innerHTML = `<p class="text-sm text-red-400 text-center">댓글 로딩 오류: ${error.message}</p>`;
                    return;
                }
                listEl.innerHTML = (!data || data.length === 0) ? '<p class="text-sm theme-text-subtitle text-center">첫 댓글을 남겨보세요!</p>' : '';
                buildCommentTree(data).forEach(c => renderComment(c, listEl));
            };

            const postBoardComment = async (boardType, nickInput, commentInput, parentId = null) => {
                const text = commentInput.value.trim();
                if (text) {
                    const { data, error } = await supabase.from('comments').insert([{ nickname: nickInput.value.trim() || '익명', text, parent_id: parentId, board_type: boardType, user_id: currentUserId }]).select();
                    if (error) console.error(`Error posting comment:`, error);
                    else {
                        commentInput.value = '';
                        if (data && data.length > 0) {
                            await supabase.from('notifications').insert({ comment_id: data[0].id, comment_text: data[0].text, commenter_nickname: data[0].nickname, board_type: data[0].board_type });
                        }
                        if (boardType === 'restaurant_comments') fetchAndRenderBoardComments('restaurant_comments', restaurantCommentList);
                        else if (boardType === 'general_comments') fetchAndRenderBoardComments('general_comments', generalCommentList);
                    }
                }
            };

            toggleRestaurantBtn.addEventListener('click', () => {
                const isOpen = restaurantCommentsContainer.classList.toggle('open');
                toggleRestaurantBtn.querySelector('svg').classList.toggle('rotate-180');
                if (isOpen) fetchAndRenderBoardComments('restaurant_comments', restaurantCommentList);
            });
            restaurantCommentPostBtn.addEventListener('click', () => postBoardComment('restaurant_comments', restaurantNicknameInput, restaurantCommentInput));
            restaurantCommentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); restaurantCommentPostBtn.click(); } });

            toggleGeneralBtn.addEventListener('click', () => {
                const isOpen = generalCommentsContainer.classList.toggle('open');
                toggleGeneralBtn.querySelector('svg').classList.toggle('rotate-180');
                if (isOpen) fetchAndRenderBoardComments('general_comments', generalCommentList);
            });
            generalCommentPostBtn.addEventListener('click', () => postBoardComment('general_comments', generalNicknameInput, generalCommentInput));
            generalCommentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generalCommentPostBtn.click(); } });


            // --- Event Delegation for Sliders and Lightbox ---
            document.querySelector('.container').addEventListener('click', (e) => {
                // Slider Logic
                const prevBtn = e.target.closest('.slider-btn.prev');
                const nextBtn = e.target.closest('.slider-btn.next');

                if (prevBtn || nextBtn) {
                    const slider = e.target.closest('.slider-container');
                    const track = slider.querySelector('.slider-track');
                    const slides = slider.querySelectorAll('.slider-slide');
                    const slideCount = slides.length;
                    let currentIndex = parseInt(slider.dataset.currentSlide, 10);

                    if (nextBtn) {
                        currentIndex = (currentIndex + 1) % slideCount;
                    } else if (prevBtn) {
                        currentIndex = (currentIndex - 1 + slideCount) % slideCount;
                    }

                    slider.dataset.currentSlide = currentIndex;
                    track.style.transform = `translateX(-${currentIndex * 100}%)`;
                }

                // Lightbox Logic
                const image = e.target.closest('.restaurant-image');
                if (image) {
                    const cardDetails = image.closest('.details');
                    let imageUrls = [];
                    const clickedIndex = parseInt(image.dataset.index, 10);

                    const allImages = cardDetails.querySelectorAll('.restaurant-image');
                    allImages.forEach(img => imageUrls.push(img.src));
                    
                    openLightbox(imageUrls, clickedIndex);
                }
            });


            // --- Real-time Subscriptions ---
            const createSubscription = (table, callback) => supabase.channel(`public:${table}`).on('postgres_changes', { event: '*', schema: 'public', table }, callback).subscribe();
            
            createSubscription('comments', payload => {
                const boardType = payload.new?.board_type || payload.old?.board_type;
                if (boardType === 'restaurant_comments') fetchAndRenderBoardComments('restaurant_comments', restaurantCommentList);
                else if (boardType === 'general_comments') fetchAndRenderBoardComments('general_comments', generalCommentList);
            });
            createSubscription('notifications', () => updateNotificationCount());
            createSubscription('restaurant_reviews', () => { updateSikdaeList(); updateGangnamList(); updatePubList(); });
            createSubscription('user_place_interactions', payload => {
                const placeType = payload.new?.place_type || payload.old?.place_type;
                if (placeType === 'sikdae') updateSikdaeList();
                else if (placeType === 'gangnam') updateGangnamList();
                else if (placeType === 'pub') updatePubList();
            });

            const presenceChannel = supabase.channel('online-users');
            presenceChannel.on('presence', { event: 'sync' }, () => {
                const userCount = Object.keys(presenceChannel.presenceState()).length;
                document.getElementById('presence-counter').textContent = `현재 ${userCount}명 접속 중`;
            }).subscribe(async (status) => {
                if (status === 'SUBSCRIBED') await presenceChannel.track({ online_at: new Date().toISOString() });
            });

            // --- Initial Load ---
            switchTab('community');
            updateSikdaeList();
            updateGangnamList();
            updatePubList();
        });
    </script>
</body>
</html>
